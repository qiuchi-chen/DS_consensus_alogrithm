<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raft Algorithm Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>

<body>
    <div id="vis"></div>
    <script>
        // 以下是Python代码翻译为JavaScript的部分
        function RaftNode(node_id) {
            this.node_id = node_id;
            this.state = "Follower";
            this.current_term = 0;
            this.voted_for = null;
            this.log = [];
            this.election_timeout = (Math.random() * (300 - 150) + 150) / 1000;
            this.last_heartbeat_time = Date.now() / 1000;
            this.is_failed = false;
            this.commit_index = 0;
            this.last_applied = 0;
            this.next_index = {};
            this.match_index = {};
        }

        RaftNode.prototype.handle_heartbeat = function (leader_id, term) {
            if (term >= this.current_term) {
                this.state = "Follower";
                this.leader_id = leader_id;
                this.last_heartbeat_time = Date.now() / 1000;
                if (term > this.current_term) {
                    this.current_term = term;
                    this.voted_for = null;
                }
            }
        };

        RaftNode.prototype.start_election = function (all_nodes) {
            if (this.state === "Follower" && ((Date.now() / 1000) - this.last_heartbeat_time) > this.election_timeout) {
                this.state = "Candidate";
                this.current_term++;
                this.voted_for = this.node_id;
                let vote_count = 1;
                for (let other_node of all_nodes) {
                    if (other_node.node_id !== this.node_id && !other_node.is_failed) {
                        let [granted, _] = other_node.handle_vote_request(this.current_term, this.node_id,
                            this.log.length,
                            this.log.length > 0 ? this.log[this.log.length - 1][0] : 0);
                        if (granted) {
                            vote_count++;
                        }
                    }
                }
                if (vote_count > all_nodes.length / 2) {
                    this.become_leader(all_nodes);
                }
            }
        };

        RaftNode.prototype.handle_vote_request = function (candidate_term, candidate_id, last_log_index, last_log_term) {
            if (candidate_term < this.current_term) {
                return [false, this.current_term];
            }
            if ((this.voted_for === null || this.voted_for === candidate_id) && this.log_is_up_to_date(last_log_index,
                    last_log_term)) {
                this.voted_for = candidate_id;
                if (candidate_term > this.current_term) {
                    this.current_term = candidate_term;
                }
                return [true, this.current_term];
            }
            return [false, this.current_term];
        };

        RaftNode.prototype.log_is_up_to_date = function (candidate_index, candidate_term) {
            let my_last_index = this.log.length;
            let my_last_term = this.log.length > 0 ? this.log[this.log.length - 1][0] : 0;
            return (candidate_term > my_last_term) || (candidate_term === my_last_term && candidate_index >= my_last_index);
        };

        RaftNode.prototype.become_leader = function (all_nodes) {
            this.state = "Leader";
            for (let other_node of all_nodes) {
                if (other_node.node_id !== this.node_id && !other_node.is_failed) {
                    other_node.handle_heartbeat(this.node_id, this.current_term);
                }
            }
            for (let node of all_nodes) {
                if (node !== this) {
                    this.next_index[node.node_id] = this.log.length + 1;
                    this.match_index[node.node_id] = 0;
                }
            }
        };

        RaftNode.prototype.send_heartbeat = function (all_nodes) {
            if (this.state === "Leader") {
                for (let other_node of all_nodes) {
                    if (other_node.node_id !== this.node_id && !other_node.is_failed) {